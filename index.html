<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chambas Conecta | Negocios y Servicios</title>
  
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#0b1a34">
  
  <style>
    :root{
      --bg:#0b1220; --text:#e9eefc; --muted:#a9b6dd;
      --brand:#4cc9f0; --brand2:#7c5cff; --ok:#2dd4bf; --danger:#ff4d6d;
      --border:rgba(255,255,255,.10); --shadow: 0 18px 45px rgba(0,0,0,.45);
      --radius:18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; font-family: Arial, Helvetica, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(124,92,255,.22), transparent 60%),
        radial-gradient(1000px 600px at 85% 30%, rgba(76,201,240,.18), transparent 55%),
        radial-gradient(900px 500px at 50% 90%, rgba(45,212,191,.10), transparent 60%),
        var(--bg);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
    }

    .app{
      width:min(1100px, 100%);
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:18px;
    }

    .card{
      background: rgba(255,255,255,.06);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }

    .hero{
      padding:26px 26px 22px 26px;
      position:relative;
      min-height: 420px;
    }

    .badge{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.25);
      color:var(--muted);
      font-size:13px;
    }

    .dot{
      width:10px;height:10px;border-radius:50%;
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      box-shadow:0 0 16px rgba(124,92,255,.8);
    }

    h1{
      margin:14px 0 8px 0;
      font-size:34px;
      letter-spacing:.2px;
      line-height:1.15;
    }
    .subtitle{
      margin:0;
      color:var(--muted);
      font-size:15px;
      line-height:1.6;
      max-width: 52ch;
    }

    .features{
      margin-top:18px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    .feat{
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
    }
    .feat b{ display:block; margin-bottom:4px; }
    .feat span{ color:var(--muted); font-size:13px; line-height:1.4; }

    .login{ padding:22px; }
    .login h2{ margin:0 0 10px 0; font-size:20px; }
    .muted{ color:var(--muted); font-size:13px; margin:0 0 16px 0; }

    label{ display:block; font-size:13px; color:var(--muted); margin:10px 0 6px; }
    input, textarea, select{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      outline:none;
      background: rgba(0,0,0,.25);
      color:var(--text);
      font-size:15px;
    }
    textarea{ min-height: 96px; resize: vertical; }
    input:focus, textarea:focus, select:focus{
      border-color: rgba(76,201,240,.6);
      box-shadow: 0 0 0 3px rgba(76,201,240,.18);
    }

    .row{
      display:flex; gap:10px; align-items:center; margin-top:14px;
    }

    .btn{
      width:100%;
      padding:12px 14px;
      border-radius:14px;
      border:0;
      cursor:pointer;
      font-weight:700;
      color:#07101f;
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      box-shadow: 0 10px 24px rgba(124,92,255,.25);
      transition: transform .08s ease;
      text-align:center;
      text-decoration:none;
      display:inline-block;
    }
    .btn:active{ transform: scale(.98); }
    .btn.secondary{
      background: rgba(255,255,255,.10);
      color: var(--text);
      border:1px solid var(--border);
      box-shadow:none;
    }
    .btn.danger{
      background: rgba(255,77,109,.16);
      color: #ffd4dc;
      border:1px solid rgba(255,77,109,.35);
      box-shadow:none;
    }
    .btn.ok{
      background: rgba(45,212,191,.18);
      color:#c9fff7;
      border:1px solid rgba(45,212,191,.35);
      box-shadow:none;
    }

    .alert{
      margin-top:12px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      font-size:13px;
      display:none;
      line-height:1.35;
    }
    .alert.ok{ display:block; border-color: rgba(45,212,191,.45); background: rgba(45,212,191,.12); color:#c9fff7; }
    .alert.err{ display:block; border-color: rgba(255,77,109,.45); background: rgba(255,77,109,.10); color:#ffd4dc; }

    .small{
      font-size:12px; color:var(--muted); margin-top:12px; line-height:1.4;
    }

    /* PANTALLAS */
    .panel, .publish, .public{
      grid-column: 1 / -1;
      padding:22px;
      display:none;
    }

    .topbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:space-between;
      align-items:center;
      margin-bottom:16px;
    }
    .who{
      display:flex;
      gap:10px;
      align-items:center;
      color:var(--muted);
      font-size:13px;
    }
    .who b{ color:var(--text); }
    .pill{
      padding:7px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      background: rgba(0,0,0,.22);
      color:var(--muted);
      font-size:12px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    .box{
      padding:14px;
      border-radius:16px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
    }
    .box h3{ margin:0 0 8px 0; font-size:16px; }
    .box p{ margin:0; color:var(--muted); font-size:13px; line-height:1.5; }

    .cta{
      margin-top:14px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }

    /* Publicar oferta */
    .two{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      align-items:start;
    }
    .preview{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .imgwrap{
      width:100%;
      border:1px solid var(--border);
      border-radius:16px;
      overflow:hidden;
      background: rgba(0,0,0,.22);
      min-height: 220px;
      display:flex;
      align-items:center;
      justify-content:center;
      color:var(--muted);
      font-size:13px;
      text-align:center;
      padding:10px;
    }
    .imgwrap img{
      width:100%;
      height:auto;
      display:none;
    }

    /* Cards ofertas */
    .list{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    .offer{
      border:1px solid var(--border);
      border-radius:16px;
      overflow:hidden;
      background: rgba(0,0,0,.18);
    }
    .offer .pic{
      width:100%;
      height:170px;
      background: rgba(255,255,255,.06);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .offer .pic img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .offer .body{
      padding:12px;
    }
    .offer .title{
      font-weight:800;
      margin:0 0 6px 0;
      font-size:15px;
    }
    .offer .meta{
      margin:0 0 8px 0;
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
    }
    .offer .actions{
      display:flex;
      gap:10px;
      margin-top:10px;
      flex-wrap:wrap;
    }
    .chip{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      font-size:12px;
    }
    .hr{
      height:1px;
      background: rgba(255,255,255,.10);
      margin: 12px 0;
    }

    /* Filtros p√∫blico */
    .filters{
      display:grid;
      grid-template-columns: 2fr 1fr 1fr;
      gap:10px;
      align-items:end;
      margin-top:8px;
    }

    @media (max-width: 900px){
      .app{ grid-template-columns: 1fr; }
      .hero{ min-height: unset; }
      .features{ grid-template-columns:1fr; }
      .grid{ grid-template-columns:1fr; }
      .two{ grid-template-columns:1fr; }
      .list{ grid-template-columns:1fr; }
      .filters{ grid-template-columns:1fr; }
    }
  </style>
</head>

<body>
  <div class="app">
    <!-- HOME / HERO -->
    <div class="card hero" id="leftCard">
      <div class="badge"><span class="dot"></span> Plataforma local ‚Ä¢ Municipio Chambas</div>
      <h1>Chambas Conecta</h1>
      <p class="subtitle">
        Un lugar para conectar <b>negocios</b> y <b>clientes</b>: ofertas con precios, fotos y contacto.
      </p>

      <div class="features">
        <div class="feat"><b>üåê P√∫blico</b><span>Clientes ven ofertas sin login y pueden buscar.</span></div>
        <div class="feat"><b>üì£ Ofertas</b><span>Negocios publican con precio obligatorio.</span></div>
        <div class="feat"><b>üí¨ Contacto</b><span>Botones para llamar y WhatsApp.</span></div>
        <div class="feat"><b>üîí Acceso</b><span>Login solo para publicar.</span></div>
      </div>

      <div class="cta">
        <button class="btn" type="button" id="btnGoPublic">Ver ofertas (P√∫blico)</button>
        <button class="btn secondary" type="button" id="btnGoLogin">Entrar (Negocio/Admin)</button>
      </div>

      <p class="small">
        Nota: Por ahora es local (tel√©fono). Luego lo conectamos a internet para que sea ‚Äúreal‚Äù para todos.
      </p>
    </div>

    <!-- LOGIN -->
    <div class="card login" id="loginCard">
      <h2>Iniciar sesi√≥n</h2>
      <p class="muted">Prueba: <b>admin/1234</b> o <b>negocio/2025</b></p>

      <form id="loginForm" autocomplete="on">
        <label for="user">Usuario</label>
        <input id="user" name="user" type="text" placeholder="Ej: admin" required />

        <label for="pass">Contrase√±a</label>
        <input id="pass" name="pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required />

        <div class="row">
          <button class="btn" type="submit">Entrar</button>
        </div>

        <div class="row">
          <button class="btn secondary" type="button" id="btnDemo">Rellenar datos de prueba</button>
        </div>

        <div class="row">
          <button class="btn secondary" type="button" id="btnPublicFromLogin">Ver ofertas (P√∫blico)</button>
        </div>

        <div id="msg" class="alert"></div>

        <div class="row">
          <button class="btn secondary" type="button" id="btnBackHomeFromLogin">Volver al inicio</button>
        </div>
      </form>
    </div>

    <!-- PANEL -->
    <div class="card panel" id="panelCard">
      <div class="topbar">
        <div class="who">
          <span class="pill">‚úÖ Sesi√≥n activa</span>
          <span>Usuario: <b id="whoUser">-</b></span>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn secondary" type="button" id="btnPublicFromPanel">Ver p√∫blico</button>
          <button class="btn secondary" type="button" id="btnClear">Borrar datos</button>
          <button class="btn" type="button" id="btnLogout">Salir</button>
        </div>
      </div>

      <div class="grid">
        <div class="box">
          <h3>üì£ Publicar oferta</h3>
          <p>
            Publica productos con <b>foto</b>, <b>precio obligatorio</b>,
            <b>moneda libre</b>, descripci√≥n y contacto.
          </p>
        </div>
        <div class="box">
          <h3>üåê P√∫blico</h3>
          <p>
            As√≠ lo ven los clientes: b√∫squeda, filtros y botones de contacto.
          </p>
        </div>
        <div class="box">
          <h3>üß∞ Servicios</h3>
          <p>
            Pr√≥ximo paso: publicar servicios (plomero, barber√≠a, etc.).
          </p>
        </div>
        <div class="box">
          <h3>‚öôÔ∏è Futuro</h3>
          <p>
            Luego conectamos a servidor para que sea real para todos.
          </p>
        </div>
      </div>

      <div class="cta">
        <button class="btn" type="button" id="btnNext">Continuar: Publicar oferta</button>
        <button class="btn secondary" type="button" id="btnBackToLogin">Volver al login</button>
      </div>
    </div>

    <!-- PUBLICAR OFERTA -->
    <div class="card publish" id="publishCard">
      <div class="topbar">
        <div class="who">
          <span class="pill">üì£ Publicar oferta</span>
          <span>Usuario: <b id="whoUser2">-</b></span>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn secondary" type="button" id="btnBackPanel">Volver al panel</button>
          <button class="btn secondary" type="button" id="btnPublicFromPublish">Ver p√∫blico</button>
          <button class="btn" type="button" id="btnLogout2">Salir</button>
        </div>
      </div>

      <div class="two">
        <div class="box">
          <h3>Formulario</h3>
          <p class="muted" style="margin-top:-2px;">Precio obligatorio ‚úÖ. Moneda libre (CUP, USD, etc.).</p>

          <form id="offerForm">
            <label for="oTitle">T√≠tulo / Producto</label>
            <input id="oTitle" type="text" placeholder="Ej: Cemento, Aceite, Pollo..." required />

            <div class="row" style="margin-top:10px;">
              <div style="flex:1;">
                <label for="oPrice">Precio (obligatorio)</label>
                <input id="oPrice" type="number" inputmode="decimal" min="0" step="0.01" placeholder="Ej: 4000" required />
              </div>
              <div style="flex:1;">
                <label for="oCurrency">Moneda (libre)</label>
                <input id="oCurrency" type="text" placeholder="Ej: CUP / USD" />
              </div>
            </div>

            <label for="oDesc">Descripci√≥n</label>
            <textarea id="oDesc" placeholder="Detalles: cantidad, marca, entrega, etc."></textarea>

            <div class="row" style="margin-top:10px;">
              <div style="flex:1;">
                <label for="oPhone">Tel√©fono</label>
                <input id="oPhone" type="tel" placeholder="Ej: +53..." />
              </div>
              <div style="flex:1;">
                <label for="oWhats">WhatsApp</label>
                <input id="oWhats" type="tel" placeholder="Ej: +53..." />
              </div>
            </div>

            <label for="oPhoto">Foto (opcional)</label>
            <input id="oPhoto" type="file" accept="image/*" />

            <div class="row">
              <button class="btn" type="submit">Guardar oferta</button>
            </div>
            <div class="row">
              <button class="btn secondary" type="button" id="btnClearForm">Limpiar formulario</button>
            </div>

            <div id="offerMsg" class="alert"></div>

            <p class="small">Consejo: usa fotos no muy pesadas para que no se llene el almacenamiento.</p>
          </form>
        </div>

        <div class="preview box">
          <h3>Vista previa</h3>
          <div class="imgwrap" id="imgWrap">
            <div id="imgHint">Aqu√≠ ver√°s la foto seleccionada.</div>
            <img id="imgPreview" alt="Vista previa" />
          </div>

          <div class="hr"></div>

          <div class="chip">üì¶ <span id="pvTitle">T√≠tulo‚Ä¶</span></div>
          <div class="chip">üí≤ <span id="pvPrice">Precio‚Ä¶</span> <span id="pvCurrency"></span></div>
          <div class="chip">üìù <span id="pvDesc">Descripci√≥n‚Ä¶</span></div>
          <div class="chip">üìû <span id="pvPhone">Tel√©fono‚Ä¶</span></div>
          <div class="chip">üí¨ <span id="pvWhats">WhatsApp‚Ä¶</span></div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="topbar" style="margin-bottom:10px;">
        <div class="who">
          <span class="pill">üìã Ofertas guardadas</span>
          <span class="muted">Se guardan en tu tel√©fono</span>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn secondary" type="button" id="btnExport">Exportar (copiar)</button>
          <button class="btn danger" type="button" id="btnDeleteAll">Borrar todas</button>
        </div>
      </div>

      <div id="offersList" class="list"></div>
      <div id="offersEmpty" class="muted" style="display:none;">A√∫n no hay ofertas guardadas. Crea la primera üëÜ</div>
    </div>

    <!-- P√öBLICO (CLIENTES) -->
    <div class="card public" id="publicCard">
      <div class="topbar">
        <div class="who">
          <span class="pill">üåê P√∫blico</span>
          <span class="muted">Ofertas para clientes (sin login)</span>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn secondary" type="button" id="btnPublicRefresh">Actualizar</button>
          <button class="btn secondary" type="button" id="btnPublicBack">Volver</button>
          <button class="btn" type="button" id="btnPublicLogin">Entrar</button>
        </div>
      </div>

      <div class="box">
        <h3>Buscar y filtrar</h3>

        <div class="filters">
          <div>
            <label for="fSearch">Buscar (t√≠tulo o descripci√≥n)</label>
            <input id="fSearch" type="text" placeholder="Ej: cemento, pollo, aceite..." />
          </div>
          <div>
            <label for="fCurrency">Moneda</label>
            <input id="fCurrency" type="text" placeholder="Ej: CUP" />
          </div>
          <div>
            <label for="fOrder">Orden</label>
            <select id="fOrder">
              <option value="new">M√°s nuevas</option>
              <option value="old">M√°s viejas</option>
            </select>
          </div>
        </div>

        <div class="row">
          <button class="btn secondary" type="button" id="btnPublicClear">Limpiar filtros</button>
          <button class="btn secondary" type="button" id="btnPublicShareApp">Compartir app</button>
        </div>

        <p class="small">
          Por ahora ‚ÄúP√∫blico‚Äù muestra ofertas guardadas en ESTE tel√©fono. Cuando conectemos a servidor, ser√° p√∫blico para todos.
        </p>
      </div>

      <div class="hr"></div>

      <div class="topbar" style="margin-bottom:10px;">
        <div class="who">
          <span class="pill">üì£ Ofertas</span>
          <span class="muted" id="publicCount">0</span>
        </div>
      </div>

      <div id="publicList" class="list"></div>
      <div id="publicEmpty" class="muted" style="display:none;">No hay ofertas para mostrar todav√≠a.</div>
    </div>
  </div>

  <script>
    // =========================
    // UTILIDADES
    // =========================
    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function normalizePhone(p){
      return String(p||"").trim().replace(/\s+/g,"");
    }

    function fmtMoney(price, currency){
      const p = (price === "" || price === null || typeof price === "undefined") ? "" : String(price);
      const c = (currency || "").trim();
      return c ? `${p} ${c}` : p;
    }

    async function shareText(title, text){
      try{
        if(navigator.share){
          await navigator.share({ title, text });
          return true;
        }
      }catch(e){}
      return false;
    }

    function copyToClipboard(text, okCb, errCb){
      if(navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(text).then(()=> okCb && okCb()).catch(()=> fallbackCopy(text, okCb, errCb));
      } else {
        fallbackCopy(text, okCb, errCb);
      }
    }

    function fallbackCopy(text, okCb, errCb){
      const ta = document.createElement("textarea");
      ta.value = text;
      ta.style.position = "fixed";
      ta.style.opacity = "0";
      document.body.appendChild(ta);
      ta.select();
      try{
        document.execCommand("copy");
        okCb && okCb();
      }catch(e){
        errCb && errCb();
        alert(text);
      }
      document.body.removeChild(ta);
    }

    function placeholderImg(){
      return "data:image/svg+xml;charset=UTF-8," + encodeURIComponent(
        `<svg xmlns='http://www.w3.org/2000/svg' width='600' height='320'>
          <rect width='100%' height='100%' fill='rgba(255,255,255,0.06)'/>
          <text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle'
            fill='rgba(233,238,252,0.55)' font-family='Arial' font-size='18'>Sin foto</text>
        </svg>`
      );
    }

    // =========================
    // STORAGE
    // =========================
    function getOffers(){
      try{
        const raw = localStorage.getItem("cc_offers");
        return raw ? JSON.parse(raw) : [];
      }catch(e){
        return [];
      }
    }
    function setOffers(list){
      localStorage.setItem("cc_offers", JSON.stringify(list));
    }

    // =========================
    // NAVEGACI√ìN
    // =========================
    const loginCard = document.getElementById("loginCard");
    const panelCard = document.getElementById("panelCard");
    const publishCard = document.getElementById("publishCard");
    const publicCard = document.getElementById("publicCard");

    function showOnly(screen){
      // screen: "home" | "login" | "panel" | "publish" | "public"
      loginCard.style.display = (screen === "login") ? "block" : "none";
      panelCard.style.display = (screen === "panel") ? "block" : "none";
      publishCard.style.display = (screen === "publish") ? "block" : "none";
      publicCard.style.display = (screen === "public") ? "block" : "none";
      if(screen === "home"){
        loginCard.style.display = "none";
        panelCard.style.display = "none";
        publishCard.style.display = "none";
        publicCard.style.display = "none";
      }
    }

    function currentUser(){
      return localStorage.getItem("cc_user");
    }

    // recordar desde d√≥nde abrimos "P√∫blico"
    function lastScreen(){
      return sessionStorage.getItem("cc_last_screen") || "home";
    }
    function setLastScreen(s){
      sessionStorage.setItem("cc_last_screen", s);
    }

    // =========================
    // LOGIN
    // =========================
    const USERS = { "admin": "1234", "negocio": "2025" };

    const loginForm = document.getElementById("loginForm");
    const msg = document.getElementById("msg");
    const userInput = document.getElementById("user");
    const passInput = document.getElementById("pass");

    const whoUser = document.getElementById("whoUser");
    const whoUser2 = document.getElementById("whoUser2");

    const btnGoPublic = document.getElementById("btnGoPublic");
    const btnGoLogin = document.getElementById("btnGoLogin");
    const btnDemo = document.getElementById("btnDemo");
    const btnLogout = document.getElementById("btnLogout");
    const btnLogout2 = document.getElementById("btnLogout2");
    const btnClear = document.getElementById("btnClear");
    const btnNext = document.getElementById("btnNext");
    const btnBackToLogin = document.getElementById("btnBackToLogin");
    const btnBackPanel = document.getElementById("btnBackPanel");

    const btnPublicFromLogin = document.getElementById("btnPublicFromLogin");
    const btnPublicFromPanel = document.getElementById("btnPublicFromPanel");
    const btnPublicFromPublish = document.getElementById("btnPublicFromPublish");
    const btnBackHomeFromLogin = document.getElementById("btnBackHomeFromLogin");

    function showMsg(type, text){
      msg.className = "alert " + (type === "ok" ? "ok" : "err");
      msg.textContent = text;
    }
    function clearMsg(){
      msg.className = "alert";
      msg.textContent = "";
    }

    function setUserUI(){
      const u = currentUser() || "-";
      whoUser.textContent = u;
      whoUser2.textContent = u;
    }

    function showLogin(){
      showOnly("login");
      clearMsg();
      passInput.value = "";
      userInput.focus();
    }
    function showPanel(){
      setUserUI();
      showOnly("panel");
      clearMsg();
    }
    function showPublish(){
      setUserUI();
      showOnly("publish");
      renderOffers();
      clearOfferMsg();
    }
    function showPublic(from){
      setLastScreen(from || "home");
      showOnly("public");
      renderPublic();
    }

    btnGoLogin.addEventListener("click", showLogin);
    btnGoPublic.addEventListener("click", ()=>showPublic("home"));
    btnBackHomeFromLogin.addEventListener("click", ()=>showOnly("home"));

    btnPublicFromLogin.addEventListener("click", ()=>showPublic("login"));
    btnPublicFromPanel.addEventListener("click", ()=>showPublic("panel"));
    btnPublicFromPublish.addEventListener("click", ()=>showPublic("publish"));

    loginForm.addEventListener("submit", function(e){
      e.preventDefault();
      const u = (userInput.value || "").trim().toLowerCase();
      const p = (passInput.value || "").trim();

      if(!u || !p){
        showMsg("err", "Completa usuario y contrase√±a.");
        return;
      }
      if(USERS[u] && USERS[u] === p){
        localStorage.setItem("cc_user", u);
        showMsg("ok", "‚úÖ Login correcto. Entrando...");
        setTimeout(showPanel, 300);
      } else {
        showMsg("err", "‚ùå Usuario o contrase√±a incorrectos.");
      }
    });

    btnDemo.addEventListener("click", function(){
      userInput.value = "admin";
      passInput.value = "1234";
      clearMsg();
      passInput.focus();
    });

    function logout(){
      localStorage.removeItem("cc_user");
      showOnly("home");
      showMsg("ok", "Sesi√≥n cerrada.");
    }
    btnLogout.addEventListener("click", logout);
    btnLogout2.addEventListener("click", logout);

    btnClear.addEventListener("click", function(){
      localStorage.clear();
      showOnly("home");
      showMsg("ok", "Datos locales borrados.");
    });

    btnNext.addEventListener("click", showPublish);
    btnBackToLogin.addEventListener("click", showLogin);
    btnBackPanel.addEventListener("click", showPanel);

    // =========================
    // OFERTAS (PUBLICAR + LISTAR)
    // =========================
    const offerForm = document.getElementById("offerForm");
    const offerMsg = document.getElementById("offerMsg");

    const oTitle = document.getElementById("oTitle");
    const oPrice = document.getElementById("oPrice");
    const oCurrency = document.getElementById("oCurrency");
    const oDesc = document.getElementById("oDesc");
    const oPhone = document.getElementById("oPhone");
    const oWhats = document.getElementById("oWhats");
    const oPhoto = document.getElementById("oPhoto");

    const imgHint = document.getElementById("imgHint");
    const imgPreview = document.getElementById("imgPreview");

    const pvTitle = document.getElementById("pvTitle");
    const pvPrice = document.getElementById("pvPrice");
    const pvCurrency = document.getElementById("pvCurrency");
    const pvDesc = document.getElementById("pvDesc");
    const pvPhone = document.getElementById("pvPhone");
    const pvWhats = document.getElementById("pvWhats");

    const offersList = document.getElementById("offersList");
    const offersEmpty = document.getElementById("offersEmpty");

    const btnClearForm = document.getElementById("btnClearForm");
    const btnDeleteAll = document.getElementById("btnDeleteAll");
    const btnExport = document.getElementById("btnExport");

    function showOfferMsg(type, text){
      offerMsg.className = "alert " + (type === "ok" ? "ok" : "err");
      offerMsg.textContent = text;
    }
    function clearOfferMsg(){
      offerMsg.className = "alert";
      offerMsg.textContent = "";
    }

    function resetPreview(){
      imgHint.style.display = "block";
      imgPreview.style.display = "none";
      imgPreview.src = "";

      pvTitle.textContent = "T√≠tulo‚Ä¶";
      pvPrice.textContent = "Precio‚Ä¶";
      pvCurrency.textContent = "";
      pvDesc.textContent = "Descripci√≥n‚Ä¶";
      pvPhone.textContent = "Tel√©fono‚Ä¶";
      pvWhats.textContent = "WhatsApp‚Ä¶";
    }

    function updatePreview(){
      pvTitle.textContent = (oTitle.value || "T√≠tulo‚Ä¶").trim() || "T√≠tulo‚Ä¶";
      pvPrice.textContent = (oPrice.value || "Precio‚Ä¶").trim() || "Precio‚Ä¶";
      pvCurrency.textContent = (oCurrency.value || "").trim() ? (" " + oCurrency.value.trim()) : "";
      pvDesc.textContent = (oDesc.value || "Descripci√≥n‚Ä¶").trim() || "Descripci√≥n‚Ä¶";
      pvPhone.textContent = (oPhone.value || "Tel√©fono‚Ä¶").trim() || "Tel√©fono‚Ä¶";
      pvWhats.textContent = (oWhats.value || "WhatsApp‚Ä¶").trim() || "WhatsApp‚Ä¶";
    }

    ["input","change"].forEach(ev=>{
      oTitle.addEventListener(ev, updatePreview);
      oPrice.addEventListener(ev, updatePreview);
      oCurrency.addEventListener(ev, updatePreview);
      oDesc.addEventListener(ev, updatePreview);
      oPhone.addEventListener(ev, updatePreview);
      oWhats.addEventListener(ev, updatePreview);
    });

    let selectedPhotoBase64 = "";

    oPhoto.addEventListener("change", function(){
      const file = oPhoto.files && oPhoto.files[0];
      if(!file){
        selectedPhotoBase64 = "";
        imgHint.style.display = "block";
        imgPreview.style.display = "none";
        imgPreview.src = "";
        return;
      }
      const reader = new FileReader();
      reader.onload = function(e){
        selectedPhotoBase64 = String(e.target.result || "");
        imgHint.style.display = "none";
        imgPreview.style.display = "block";
        imgPreview.src = selectedPhotoBase64;
      };
      reader.readAsDataURL(file);
    });

    function renderOffers(){
      const list = getOffers();
      offersList.innerHTML = "";

      if(!list.length){
        offersEmpty.style.display = "block";
        return;
      }
      offersEmpty.style.display = "none";

      list
        .slice()
        .sort((a,b)=> (b.createdAt||0) - (a.createdAt||0))
        .forEach(offer => {
          const card = document.createElement("div");
          card.className = "offer";

          const pic = document.createElement("div");
          pic.className = "pic";
          const img = document.createElement("img");
          img.alt = "Oferta";
          img.src = offer.photo || placeholderImg();
          pic.appendChild(img);

          const body = document.createElement("div");
          body.className = "body";

          const t = document.createElement("p");
          t.className = "title";
          t.textContent = offer.title || "Oferta";

          const meta = document.createElement("p");
          meta.className = "meta";
          const money = fmtMoney(offer.price, offer.currency);
          const desc = (offer.desc || "").trim();
          const phone = (offer.phone || "").trim();
          const whats = (offer.whats || "").trim();
          const who = (offer.user || "").trim();

          meta.innerHTML = `
            <span class="chip">üí≤ ${escapeHtml(money || "‚Äî")}</span>
            <span class="chip">üë§ ${escapeHtml(who || "‚Äî")}</span>
            <div style="height:8px"></div>
            <div>${escapeHtml(desc || "Sin descripci√≥n.")}</div>
            <div style="height:8px"></div>
            <div>üìû ${escapeHtml(phone || "‚Äî")} &nbsp; | &nbsp; üí¨ ${escapeHtml(whats || "‚Äî")}</div>
          `;

          const actions = document.createElement("div");
          actions.className = "actions";

          const copy = document.createElement("button");
          copy.className = "btn secondary";
          copy.type = "button";
          copy.textContent = "Copiar info";
          copy.addEventListener("click", function(){
            const text =
              `Oferta: ${offer.title}\n` +
              `Precio: ${money}\n` +
              `Descripci√≥n: ${desc}\n` +
              `Tel√©fono: ${phone}\n` +
              `WhatsApp: ${whats}\n` +
              `Publicado por: ${who}\n`;
            copyToClipboard(text,
              ()=> { showOfferMsg("ok","Copiado ‚úÖ"); setTimeout(clearOfferMsg, 900); },
              ()=> { showOfferMsg("err","No se pudo copiar."); setTimeout(clearOfferMsg, 900); }
            );
          });

          const del = document.createElement("button");
          del.className = "btn danger";
          del.type = "button";
          del.textContent = "Borrar";
          del.addEventListener("click", function(){
            const list2 = getOffers().filter(o => o.id !== offer.id);
            setOffers(list2);
            renderOffers();
            showOfferMsg("ok","Oferta borrada.");
            setTimeout(clearOfferMsg, 900);
          });

          actions.appendChild(copy);
          actions.appendChild(del);

          body.appendChild(t);
          body.appendChild(meta);
          body.appendChild(actions);

          card.appendChild(pic);
          card.appendChild(body);

          offersList.appendChild(card);
        });
    }

    offerForm.addEventListener("submit", function(e){
      e.preventDefault();
      clearOfferMsg();

      const u = currentUser();
      if(!u){
        showOfferMsg("err","No hay sesi√≥n. Vuelve al login.");
        showLogin();
        return;
      }

      const title = (oTitle.value || "").trim();
      const price = (oPrice.value || "").trim();
      const currency = (oCurrency.value || "").trim();
      const desc = (oDesc.value || "").trim();
      const phone = (oPhone.value || "").trim();
      const whats = (oWhats.value || "").trim();

      if(!title){
        showOfferMsg("err","El t√≠tulo es obligatorio.");
        oTitle.focus();
        return;
      }
      if(price === "" || Number(price) < 0){
        showOfferMsg("err","El precio es obligatorio y debe ser v√°lido.");
        oPrice.focus();
        return;
      }

      const offer = {
        id: "of_" + Date.now() + "_" + Math.random().toString(16).slice(2),
        user: u,
        title,
        price,
        currency,
        desc,
        phone,
        whats,
        photo: selectedPhotoBase64 || "",
        createdAt: Date.now()
      };

      const list = getOffers();
      list.push(offer);
      setOffers(list);

      showOfferMsg("ok","‚úÖ Oferta guardada.");
      selectedPhotoBase64 = "";
      offerForm.reset();
      resetPreview();
      updatePreview();
      renderOffers();
    });

    btnClearForm.addEventListener("click", function(){
      selectedPhotoBase64 = "";
      offerForm.reset();
      resetPreview();
      updatePreview();
      clearOfferMsg();
      oTitle.focus();
    });

    btnDeleteAll.addEventListener("click", function(){
      const ok = confirm("¬øSeguro que quieres borrar TODAS las ofertas?");
      if(!ok) return;
      setOffers([]);
      renderOffers();
      showOfferMsg("ok","Todas las ofertas fueron borradas.");
      setTimeout(clearOfferMsg, 900);
    });

    btnExport.addEventListener("click", function(){
      const list = getOffers();
      if(!list.length){
        showOfferMsg("err","No hay ofertas para exportar.");
        return;
      }
      const json = JSON.stringify(list, null, 2);
      copyToClipboard(json,
        ()=> { showOfferMsg("ok","Exportado (copiado) ‚úÖ"); setTimeout(clearOfferMsg, 900); },
        ()=> { showOfferMsg("err","No se pudo copiar."); setTimeout(clearOfferMsg, 900); }
      );
    });

    // =========================
    // P√öBLICO (CLIENTES)
    // =========================
    const publicList = document.getElementById("publicList");
    const publicEmpty = document.getElementById("publicEmpty");
    const publicCount = document.getElementById("publicCount");

    const fSearch = document.getElementById("fSearch");
    const fCurrency = document.getElementById("fCurrency");
    const fOrder = document.getElementById("fOrder");

    const btnPublicRefresh = document.getElementById("btnPublicRefresh");
    const btnPublicBack = document.getElementById("btnPublicBack");
    const btnPublicLogin = document.getElementById("btnPublicLogin");
    const btnPublicClear = document.getElementById("btnPublicClear");
    const btnPublicShareApp = document.getElementById("btnPublicShareApp");

    btnPublicBack.addEventListener("click", function(){
      const back = lastScreen();
      if(back === "panel" && currentUser()) showPanel();
      else if(back === "publish" && currentUser()) showPublish();
      else if(back === "login") showLogin();
      else showOnly("home");
    });

    btnPublicLogin.addEventListener("click", showLogin);
    btnPublicRefresh.addEventListener("click", renderPublic);

    btnPublicClear.addEventListener("click", function(){
      fSearch.value = "";
      fCurrency.value = "";
      fOrder.value = "new";
      renderPublic();
    });

    fSearch.addEventListener("input", renderPublic);
    fCurrency.addEventListener("input", renderPublic);
    fOrder.addEventListener("change", renderPublic);

    btnPublicShareApp.addEventListener("click", async function(){
      const text =
        "Chambas Conecta (modo local):\n" +
        "Ofertas guardadas en este tel√©fono.\n" +
        "Luego lo conectamos a internet para que sea p√∫blico para todos.\n";
      const ok = await shareText("Chambas Conecta", text);
      if(!ok){
        copyToClipboard(text, ()=>alert("Texto copiado ‚úÖ"), ()=>alert(text));
      }
    });

    function buildOfferShareText(offer){
      const money = fmtMoney(offer.price, offer.currency);
      const phone = (offer.phone||"").trim();
      const whats = (offer.whats||"").trim();
      const desc = (offer.desc||"").trim();
      return (
        `üì£ Oferta en Chambas:\n`+
        `Producto: ${offer.title}\n`+
        `Precio: ${money}\n`+
        (desc ? `Descripci√≥n: ${desc}\n` : "")+
        (phone ? `üìû Tel: ${phone}\n` : "")+
        (whats ? `üí¨ WhatsApp: ${whats}\n` : "")
      );
    }

    function renderPublic(){
      const list0 = getOffers();

      const q = (fSearch.value || "").trim().toLowerCase();
      const cur = (fCurrency.value || "").trim().toLowerCase();
      const order = fOrder.value;

      let list = list0.slice();

      if(q){
        list = list.filter(o =>
          String(o.title||"").toLowerCase().includes(q) ||
          String(o.desc||"").toLowerCase().includes(q) ||
          String(o.user||"").toLowerCase().includes(q)
        );
      }
      if(cur){
        list = list.filter(o => String(o.currency||"").trim().toLowerCase() === cur);
      }

      list.sort((a,b)=>{
        const da = a.createdAt||0, db = b.createdAt||0;
        return order === "old" ? (da - db) : (db - da);
      });

      publicList.innerHTML = "";
      publicCount.textContent = `${list.length} oferta(s)`;

      if(!list.length){
        publicEmpty.style.display = "block";
        return;
      }
      publicEmpty.style.display = "none";

      list.forEach(offer=>{
        const card = document.createElement("div");
        card.className = "offer";

        const pic = document.createElement("div");
        pic.className = "pic";
        const img = document.createElement("img");
        img.alt = "Oferta";
        img.src = offer.photo || placeholderImg();
        pic.appendChild(img);

        const body = document.createElement("div");
        body.className = "body";

        const t = document.createElement("p");
        t.className = "title";
        t.textContent = offer.title || "Oferta";

        const money = fmtMoney(offer.price, offer.currency);
        const desc = (offer.desc||"").trim();
        const phone = normalizePhone(offer.phone);
        const whats = normalizePhone(offer.whats);

        const meta = document.createElement("p");
        meta.className = "meta";
        meta.innerHTML = `
          <span class="chip">üí≤ ${escapeHtml(money || "‚Äî")}</span>
          <span class="chip">üë§ ${escapeHtml(offer.user || "‚Äî")}</span>
          <div style="height:8px"></div>
          <div>${escapeHtml(desc || "Sin descripci√≥n.")}</div>
        `;

        const actions = document.createElement("div");
        actions.className = "actions";

        if(phone){
          const aCall = document.createElement("a");
          aCall.className = "btn ok";
          aCall.href = `tel:${phone}`;
          aCall.textContent = "üìû Llamar";
          actions.appendChild(aCall);
        }

        if(whats){
          const aW = document.createElement("a");
          aW.className = "btn ok";
          aW.href = `https://wa.me/${whats.replace(/^\+/, "")}`;
          aW.target = "_blank";
          aW.rel = "noopener";
          aW.textContent = "üí¨ WhatsApp";
          actions.appendChild(aW);
        }

        const btnShare = document.createElement("button");
        btnShare.className = "btn secondary";
        btnShare.type = "button";
        btnShare.textContent = "Compartir";
        btnShare.addEventListener("click", async ()=>{
          const text = buildOfferShareText(offer);
          const ok = await shareText("Oferta", text);
          if(!ok){
            copyToClipboard(text, ()=>alert("Copiado ‚úÖ"), ()=>alert(text));
          }
        });
        actions.appendChild(btnShare);

        body.appendChild(t);
        body.appendChild(meta);
        body.appendChild(actions);

        card.appendChild(pic);
        card.appendChild(body);
        publicList.appendChild(card);
      });
    }

    // =========================
    // INIT
    // =========================
    resetPreview();
    updatePreview();

    // Si ya hay sesi√≥n, opcional: puedes ir directo a panel.
    // Por ahora abrimos HOME siempre para que sea m√°s claro.
    showOnly("home");
  </script>

  <!-- ‚úÖ Service Worker (PWA) -->
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./sw.js");
      });
    }
  </script>
</body>
  </html>
