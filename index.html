<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chambas Conecta</title>
  <style>
    :root{
      --bg0:#061022;
      --bg1:#0b1a34;
      --card:rgba(255,255,255,.06);
      --line:rgba(255,255,255,.10);
      --text:#eaf0ff;
      --muted:rgba(234,240,255,.70);
      --brand1:#36d1ff;
      --brand2:#7c5cff;
      --ok:#22c55e;
      --danger:#ff4d6d;
      --radius:18px;
      --shadow: 0 18px 60px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}

    /* ‚úÖ Portada (chambas-bg.jpg) + overlay oscuro */
    body{
  margin:0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  color:var(--text);
  min-height:100vh;

  background:
    linear-gradient(
      rgba(6,16,34,0.85),
      rgba(11,26,52,0.95)
    ),
    url("chambas-bg.jpg");

  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  background-attachment: fixed;
    }

    .wrap{max-width:760px;margin:0 auto;padding:18px 14px 40px;}
    .pill{
      display:inline-flex;align-items:center;gap:10px;
      padding:10px 14px;border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--muted);
      width:max-content;
    }
    h1{font-size:52px;line-height:1;margin:16px 0 10px;letter-spacing:-.02em;}
    .sub{color:var(--muted);font-size:18px;margin:0 0 18px;}
    .grid{display:grid;gap:14px;margin-top:14px;}
    .card{
      border:1px solid var(--line);
      border-radius:var(--radius);
      background:var(--card);
      box-shadow:var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .card .hd{padding:16px 16px 0}
    .card .bd{padding:16px}
    .title{
      font-weight:700;font-size:26px;margin:0 0 8px;display:flex;align-items:center;gap:10px;
    }
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:12px 14px;
      border-radius:999px;
      cursor:pointer;
      font-weight:650;
      transition:.15s ease;
      min-width:140px;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn.primary{
      border:none;
      background:linear-gradient(90deg, var(--brand1), var(--brand2));
      color:#061022;
    }
    .btn.danger{border:1px solid rgba(255,77,109,.35); background:rgba(255,77,109,.10)}
    .btn.secondary{background:rgba(255,255,255,.05)}
    .btn.small{padding:10px 12px; min-width:auto}
    .btn.wide{min-width:170px}
    .tag{
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      padding:8px 12px;border-radius:999px;color:var(--muted);
      font-size:14px;
    }
    .input, select, textarea{
      width:100%;
      background:rgba(0,0,0,.18);
      border:1px solid var(--line);
      color:var(--text);
      border-radius:14px;
      padding:12px 12px;
      outline:none;
    }
    label{display:block;margin:10px 0 6px;color:var(--muted);font-weight:650}
    textarea{min-height:90px;resize:vertical}
    .sep{height:1px;background:var(--line);margin:14px 0}
    .hide{display:none !important}
    .status{
      display:inline-flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:999px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.12);
      color:var(--muted);
    }
    .status.ok{border-color:rgba(34,197,94,.35); background:rgba(34,197,94,.10); color:#bff7d2}
    .status.bad{border-color:rgba(255,77,109,.35); background:rgba(255,77,109,.10); color:#ffd2da}

    /* ofertas */
    .offer{
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      border-radius:18px;
      overflow:hidden;
    }
    .offer img{width:100%; height:220px; object-fit:cover; display:block; background:#0b0f1a}
    .imgph{
      width:100%;
      height:220px;
      background:rgba(0,0,0,.22);
      display:flex;
      align-items:center;
      justify-content:center;
      color:rgba(234,240,255,.55);
      border-bottom:1px solid var(--line);
      font-weight:700;
      letter-spacing:.02em;
    }
    .offer .p{padding:14px}
    .offer h3{margin:0 0 10px;font-size:28px;line-height:1.1;word-break:break-word}
    .offer .meta{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
    .offer .meta .tag strong{color:#9ff3ff}
    .offer .actions{display:grid;gap:10px;grid-template-columns:1fr}
    .offer .actions .btn{width:100%}

    /* modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:18px;z-index:50}
    .dialog{max-width:720px;width:100%;border:1px solid var(--line);border-radius:22px;background:linear-gradient(180deg, rgba(15,23,42,.95), rgba(2,6,23,.95));box-shadow:var(--shadow);padding:16px}
    .dialog h3{margin:0 0 10px;font-size:22px}
    .dialog textarea{min-height:200px}
    .right{margin-left:auto}
    .tiny{font-size:12px;color:var(--muted)}

    /* Business Panel */
    .panelNote{
      border:1px solid var(--line);
      background:rgba(0,0,0,.12);
      border-radius:16px;
      padding:12px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    #fbStatus{ display:none !important; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row" style="align-items:flex-start; gap:14px;">
      <div style="flex:1">
        <div class="pill">üü£ Plataforma local ‚Ä¢ Municipio Chambas</div>
        <h1>Chambas<br/>Conecta</h1>
        <p class="sub">Un lugar para conectar <b>negocios</b> y <b>clientes</b>: ofertas con precios, fotos y contacto.</p>
      </div>
      <div class="status" id="fbStatus">Estado Firebase: ‚è≥ verificando‚Ä¶</div>
    </div>

    <div class="grid">

      <!-- P√∫blico -->
      <div class="card" id="cardPublic">
        <div class="hd">
          <div class="title">üåê P√∫blico</div>
        </div>
        <div class="bd">
          <div class="row">
            <button class="btn primary" id="btnGoPublic">Ver ofertas (P√∫blico)</button>
            <button class="btn" id="btnGoBusiness">Entrar (Negocio)</button>
            <button class="btn danger hide" id="btnAdmin">üõ°Ô∏è Panel Admin</button>
          </div>
          <div class="sep"></div>
          <label>Buscar</label>
          <input class="input" id="searchPublic" placeholder="Ej: pizza, pollo, sal√≥n, reparaci√≥n..." />
        </div>
      </div>

      <!-- Vista P√∫blica de Ofertas -->
      <div class="card hide" id="viewPublic">
        <div class="bd">
          <div class="row">
            <div class="title" style="margin:0">üì£ Ofertas (P√∫blico)</div>
            <button class="btn small right" id="btnBackHome1">Inicio</button>
          </div>
          <div class="sep"></div>
          <div id="publicList" class="grid"></div>
        </div>
      </div>

      <!-- Negocio -->
      <div class="card hide" id="viewBusiness">
        <div class="bd">
          <div class="row">
            <div class="title" style="margin:0">üîê Negocio</div>
            <button class="btn small right" id="btnBackHome2">Inicio</button>
          </div>

          <!-- barra panel -->
          <div class="panelNote">
            <div class="row" style="justify-content:space-between">
              <div class="row">
                <span class="tag">üë§ Sesi√≥n: <b id="sessTxt">No</b></span>
                <span class="tag hide" id="adminBadge">üõ° <b>ADMIN</b></span>
              </div>
              <button class="btn small" id="btnLogout">Salir</button>
            </div>

            <div class="sep"></div>

            <div class="row">
              <button class="btn small wide primary" id="navPublish">üìù Publicar</button>
              <button class="btn small wide" id="navMine">üìå Mis ofertas</button>
              <button class="btn small wide" id="navProfile">üè™ Perfil</button>
              <button class="btn small wide" id="navAccess">üîê Acceso</button>
              <button class="btn small wide danger hide" id="navAdmin">üõ° Admin</button>
            </div>
          </div>

          <div class="sep"></div>

          <!-- SECCI√ìN: ACCESO (SOLO CORREO) -->
          <div id="secAccess">
            <div class="card" style="box-shadow:none">
              <div class="bd">
                <div class="title" style="font-size:20px;margin:0 0 6px;">üîê Acceso</div>

                <div id="panelEmail" style="margin-top:10px;">
                  <label>Correo</label>
                  <input class="input" id="email" placeholder="ej: negocio@gmail.com"/>

                  <label>Contrase√±a</label>
                  <input class="input" id="pass" type="password" placeholder="m√≠nimo 6"/>

                  <div class="row" style="margin-top:10px;">
                    <button class="btn primary" id="btnEmailLogin">Entrar</button>
                    <button class="btn" id="btnEmailRegister">Crear cuenta</button>
                  </div>
                  <p class="tiny">* Al crear cuenta, se guarda tu perfil como <b>business</b> y ya puedes publicar.</p>
                </div>
              </div>
            </div>
          </div>

          <!-- SECCI√ìN: PERFIL -->
          <div id="secProfile" class="hide">
            <div class="card" style="box-shadow:none">
              <div class="bd">
                <div class="title" style="font-size:20px;margin:0 0 6px;">üè™ Perfil del negocio</div>
                <p class="muted">Esto se guarda en Firebase (y se usa al publicar).</p>

                <label>Nombre del negocio</label>
                <input class="input" id="bizName" placeholder="Ej: Pizza Hut Chambas"/>

                <label>Tel√©fono</label>
                <input class="input" id="bizPhone" placeholder="+53..."/>

                <label>WhatsApp</label>
                <input class="input" id="bizWa" placeholder="+53..."/>

                <div class="row" style="margin-top:10px;">
                  <button class="btn" id="btnSaveProfile">Guardar perfil</button>
                </div>
              </div>
            </div>
          </div>

          <!-- SECCI√ìN: PUBLICAR -->
          <div id="secPublish" class="hide">
            <div class="card" style="box-shadow:none">
              <div class="bd">
                <div class="title" style="font-size:20px;margin:0 0 6px;">üìù Publicar / Editar oferta</div>

                <label>Categor√≠a</label>
                <select id="categoria">
                  <option>Restaurantes</option>
                  <option>Comida</option>
                  <option>Servicios</option>
                  <option>Tiendas</option>
                  <option>Salud</option>
                  <option>Otros</option>
                </select>

                <label>T√≠tulo</label>
                <input class="input" id="title" placeholder="Ej: Combo pizza + refresco"/>

                <label>Precio</label>
                <input class="input" id="price" placeholder="Ej: 1200"/>

                <label>Moneda</label>
                <input class="input" id="currency" placeholder="CUP / USD / MLC (libre)" value="CUP"/>

                <label>Descripci√≥n</label>
                <textarea id="desc" placeholder="Describe la oferta..."></textarea>

                <label>Foto (opcional)</label>
                <input class="input" id="photo" type="file" accept="image/*"/>

                <div class="row" style="margin-top:10px;">
                  <button class="btn primary" id="btnPublish">Publicar</button>
                  <button class="btn secondary" id="btnClear">Limpiar</button>
                  <button class="btn danger" id="btnCancelEdit">Cancelar edici√≥n</button>
                </div>
              </div>
            </div>
          </div>

          <!-- SECCI√ìN: MIS OFERTAS -->
          <div id="secMine" class="hide">
            <div class="card" style="box-shadow:none">
              <div class="bd">
                <div class="row">
                  <div class="title" style="font-size:20px;margin:0">üìå Mis ofertas</div>
                  <button class="btn small right" id="btnRefreshMine">Actualizar</button>
                </div>
                <div class="sep"></div>

                <div class="row">
                  <button class="btn" id="btnExportCopy">Exportar (copiar)</button>
                  <button class="btn" id="btnExportFile">Exportar (archivo)</button>
                  <button class="btn" id="btnImportOpen">Importar</button>
                </div>

                <div class="sep"></div>
                <div id="mineList" class="grid"></div>
              </div>
            </div>
          </div>

          <!-- ‚úÖ SECCI√ìN: ADMIN -->
          <div id="secAdmin" class="hide">
            <div class="card" style="box-shadow:none">
              <div class="bd">
                <div class="row">
                  <div class="title" style="font-size:20px;margin:0">üõ° Panel Administrador</div>
                  <button class="btn small right" id="btnRefreshAdmin">Actualizar</button>
                </div>
                <p class="muted" style="margin-top:6px">
                  Aqu√≠ puedes ver y borrar <b>todas</b> las ofertas (moderaci√≥n).
                </p>

                <label>Buscar (admin)</label>
                <input class="input" id="searchAdmin" placeholder="Buscar por t√≠tulo, descripci√≥n, negocio o UID..." />

                <div class="sep"></div>

                <div class="row">
                  <button class="btn" id="btnAdminExportCopy">Exportar todo (copiar)</button>
                  <button class="btn" id="btnAdminExportFile">Exportar todo (archivo)</button>
                  <button class="btn danger" id="btnAdminDeleteAll">üß® Borrar TODO</button>
                </div>

                <div class="sep"></div>
                <div id="adminList" class="grid"></div>
              </div>
            </div>
          </div>

        </div>
      </div>

    </div>
  </div>

  <!-- MODAL: IMPORTAR -->
  <div class="modal" id="importModal">
    <div class="dialog">
      <div class="row">
        <h3 style="margin:0">üì• Importar ofertas</h3>
        <button class="btn small right" id="btnImportClose">Cerrar</button>
      </div>
      <p class="muted">Pega aqu√≠ el JSON exportado. Importa SOLO a tu cuenta (t√∫ ser√°s el ownerUid).</p>
      <label for="importText">JSON</label>
      <textarea id="importText" placeholder='[ { "title":"...", "price":"...", ... } ]'></textarea>
      <div class="row" style="margin-top:10px;">
        <button class="btn primary" id="btnImportDo">Importar</button>
      </div>
    </div>
  </div>

  <!-- MODAL: COPIA MANUAL -->
  <div class="modal" id="copyModal">
    <div class="dialog">
      <div class="row">
        <h3 style="margin:0">üìã Copiar exportaci√≥n</h3>
        <button class="btn small right" id="btnCopyClose">Cerrar</button>
      </div>
      <p class="muted">Tu navegador bloque√≥ el portapapeles. Mant√©n presionado dentro del cuadro y toca <b>Copiar</b>.</p>
      <label for="copyText">JSON</label>
      <textarea id="copyText" readonly></textarea>
      <div class="row" style="margin-top:10px;">
        <button class="btn secondary" type="button" id="btnSelectAll">Seleccionar todo</button>
      </div>
    </div>
  </div>

  <script type="module">
    // Firebase (CDN modular)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    import {
      getDatabase,
      ref,
      push,
      set,
      update,
      remove,
      get,
      onValue,
      query,
      orderByChild,
      equalTo
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

    // ‚úÖ Tu config
    const firebaseConfig = {
      apiKey: "AIzaSyAWM3XVAxvNMAlCB_hhEhFZan2xRONCro0",
      authDomain: "chambas-conecta.firebaseapp.com",
      databaseURL: "https://chambas-conecta-default-rtdb.firebaseio.com",
      projectId: "chambas-conecta",
      storageBucket: "chambas-conecta.firebasestorage.app",
      messagingSenderId: "342153426332",
      appId: "1:342153426332:web:aa5534dd8304186da00459"
    };

    // üöÄ Inicializar Firebase (UNA SOLA VEZ)
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // ---- UI helpers
    const $ = (id)=>document.getElementById(id);
    const show = (el)=>el.classList.remove("hide");
    const hide = (el)=>el.classList.add("hide");
    const toast = (msg)=>alert(msg);

    // ---- Views
    const cardPublic = $("cardPublic");
    const viewPublic = $("viewPublic");
    const viewBusiness = $("viewBusiness");

    function goHome(){
      show(cardPublic); hide(viewPublic); hide(viewBusiness);
    }
    function goPublic(){
      hide(cardPublic); show(viewPublic); hide(viewBusiness);
      renderPublic();
    }
    function goBusiness(){
      hide(cardPublic); hide(viewPublic); show(viewBusiness);
      if(currentUser) showBiz("publish"); else showBiz("access");
    }

    $("btnGoPublic").addEventListener("click", goPublic);
    $("btnGoBusiness").addEventListener("click", goBusiness);
    $("btnBackHome1").addEventListener("click", goHome);
    $("btnBackHome2").addEventListener("click", goHome);

    // ---- Business panel show/hide
    const secAccess  = $("secAccess");
    const secProfile = $("secProfile");
    const secPublish = $("secPublish");
    const secMine    = $("secMine");
    const secAdmin   = $("secAdmin");

    const navPublish = $("navPublish");
    const navMine    = $("navMine");
    const navProfile = $("navProfile");
    const navAccess  = $("navAccess");
    const navAdmin   = $("navAdmin");
    const adminBadge = $("adminBadge");

    function setNavActive(activeBtn){
      [navPublish, navMine, navProfile, navAccess, navAdmin].forEach(b=>{
        b.classList.remove("primary");
      });
      activeBtn.classList.add("primary");
    }

    function showBiz(which){
      hide(secAccess); hide(secProfile); hide(secPublish); hide(secMine); hide(secAdmin);

      if(!currentUser && which !== "access"){
        which = "access";
      }

      if(which === "admin" && !isAdmin){
        which = "publish";
      }

      if(which==="publish"){ show(secPublish); setNavActive(navPublish); }
      if(which==="mine"){ show(secMine); setNavActive(navMine); }
      if(which==="profile"){ show(secProfile); setNavActive(navProfile); }
      if(which==="access"){ show(secAccess); setNavActive(navAccess); }
      if(which==="admin"){ show(secAdmin); setNavActive(navAdmin); attachAdminListener(); }
    }

    navPublish.addEventListener("click", ()=>showBiz("publish"));
    navMine.addEventListener("click", ()=>showBiz("mine"));
    navProfile.addEventListener("click", ()=>showBiz("profile"));
    navAccess.addEventListener("click", ()=>showBiz("access"));
    navAdmin.addEventListener("click", ()=>showBiz("admin"));

    // ---- Auth state
    let currentUser = null;
    let currentProfile = null;
    let editingId = null;
    let mineUnsub = null;

    // ‚úÖ Admin state
    let isAdmin = false;
    let adminUnsub = null;
    let adminCache = [];

    function toggleAdminUI(){
      if(isAdmin){
        show(navAdmin);
        show(adminBadge);
      }else{
        hide(navAdmin);
        hide(adminBadge);
      }
    }

    async function checkAdmin(uid){
      try{
        const snap = await get(ref(db, "admins/" + uid));
        isAdmin = snap.exists();
        toggleAdminUI();
      }catch(e){
        console.error("Error verificando admin", e);
        isAdmin = false;
        toggleAdminUI();
      }
    }

    function setSessionUI(user){
      currentUser = user || null;
      $("sessTxt").textContent = user ? "S√≠" : "No";
    }

    async function ensureBusinessProfile(user){
      if(!user) return;
      const uref = ref(db, "users/" + user.uid);
      const snap = await get(uref);
      if(!snap.exists()){
        await set(uref, {
          role: "business",
          createdAt: Date.now(),
          bizName: "",
          phone: "",
          whatsapp: ""
        });
      }
      const snap2 = await get(uref);
      currentProfile = snap2.val() || null;

      $("bizName").value = currentProfile?.bizName || "";
      $("bizPhone").value = currentProfile?.phone || "";
      $("bizWa").value = currentProfile?.whatsapp || "";
    }

    onAuthStateChanged(auth, async (user)=>{
      setSessionUI(user);

      if(user){
        await ensureBusinessProfile(user);
        await checkAdmin(user.uid);
        attachMineListener();

        if(!viewBusiness.classList.contains("hide")){
          showBiz("publish");
        }
      }else{
        currentProfile = null;
        $("mineList").innerHTML = "";
        if(mineUnsub){ mineUnsub(); mineUnsub = null; }

        isAdmin = false;
        toggleAdminUI();
        adminCache = [];
        $("adminList").innerHTML = "";
        if(adminUnsub){ adminUnsub(); adminUnsub = null; }

        if(!viewBusiness.classList.contains("hide")) showBiz("access");
      }
    });

    // ---- Email auth
    $("btnEmailRegister").addEventListener("click", async ()=>{
      const email = $("email").value.trim();
      const pass = $("pass").value.trim();
      if(!email || !pass) return toast("Pon correo y contrase√±a.");
      try{
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        await ensureBusinessProfile(cred.user);
        await checkAdmin(cred.user.uid);
        toast("Cuenta creada. Ya puedes publicar ‚úÖ");
        showBiz("publish");
      }catch(e){
        console.error(e);
        toast("Error: " + (e?.message || e));
      }
    });

    $("btnEmailLogin").addEventListener("click", async ()=>{
      const email = $("email").value.trim();
      const pass = $("pass").value.trim();
      if(!email || !pass) return toast("Pon correo y contrase√±a.");
      try{
        const cred = await signInWithEmailAndPassword(auth, email, pass);
        await ensureBusinessProfile(cred.user);
        await checkAdmin(cred.user.uid);
        toast("Sesi√≥n iniciada ‚úÖ");
        showBiz("publish");
      }catch(e){
        console.error(e);
        toast("Error: " + (e?.message || e));
      }
    });

    // ---- Logout
    $("btnLogout").addEventListener("click", async ()=>{
      try{ await signOut(auth); toast("Saliste."); }catch(e){ console.error(e); }
    });

    // ---- Perfil negocio
    $("btnSaveProfile").addEventListener("click", async ()=>{
      if(!currentUser) return toast("Primero inicia sesi√≥n.");
      try{
        const uref = ref(db, "users/" + currentUser.uid);
        await update(uref, {
          bizName: $("bizName").value.trim(),
          phone: $("bizPhone").value.trim(),
          whatsapp: $("bizWa").value.trim(),
          updatedAt: Date.now()
        });
        await ensureBusinessProfile(currentUser);
        toast("Perfil guardado ‚úÖ");
      }catch(e){
        console.error(e);
        toast("Error guardando perfil: " + (e?.message || e));
      }
    });

    // ---- Foto -> base64
    function fileToBase64(file){
      return new Promise((resolve,reject)=>{
        const r = new FileReader();
        r.onload = ()=>resolve(r.result);
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }

    // ---- Publicar / editar
    $("btnPublish").addEventListener("click", async ()=>{
      if(!currentUser) return toast("Primero inicia sesi√≥n (correo).");
      await ensureBusinessProfile(currentUser);

      const data = {
        ownerUid: currentUser.uid,
        bizName: ($("bizName").value.trim() || "Negocio"),
        categoria: $("categoria").value,
        title: $("title").value.trim(),
        price: $("price").value.trim(),
        currency: $("currency").value.trim(),
        desc: $("desc").value.trim(),
        phone: $("bizPhone").value.trim(),
        whatsapp: $("bizWa").value.trim(),
        createdAt: Date.now()
      };

      if(!data.title) return toast("Pon un t√≠tulo.");
      if(!data.price) return toast("Pon un precio (obligatorio).");
      if(!data.currency) data.currency = "CUP";

      const f = $("photo").files?.[0] || null;
      if(f){
        try{ data.photo = await fileToBase64(f); }catch(e){ console.error(e); }
      }

      try{
        if(editingId){
          await update(ref(db, "publicaciones/" + editingId), data);
          toast("Oferta actualizada ‚úÖ");
        }else{
          const newRef = push(ref(db, "publicaciones"));
          await set(newRef, data);
          toast("Oferta publicada ‚úÖ");
        }
        clearForm();
        await renderPublic();
        showBiz("mine");
      }catch(e){
        console.error(e);
        toast("Error publicando: " + (e?.message || e));
      }
    });

    function clearForm(){
      editingId = null;
      $("title").value = "";
      $("price").value = "";
      $("currency").value = "CUP";
      $("desc").value = "";
      $("photo").value = "";
    }
    $("btnClear").addEventListener("click", clearForm);

    $("btnCancelEdit").addEventListener("click", ()=>{
      clearForm();
      toast("Edici√≥n cancelada.");
    });

    // ---- Render cards
    function offerCard(item, id, mode="public"){
      const div = document.createElement("div");
      div.className = "offer";

      const imgHtml = item.photo
        ? `<img src="${item.photo}" alt="Oferta">`
        : `<div class="imgph">SIN FOTO</div>`;

      const ownerLine = (mode === "admin")
        ? `<div class="tiny">ownerUid: <b>${escapeHtml(item.ownerUid || "")}</b></div>`
        : ``;

      div.innerHTML = `
        ${imgHtml}
        <div class="p">
          <h3>${escapeHtml(item.title || "")}</h3>
          <div class="meta">
            <span class="tag">üè∑Ô∏è ${escapeHtml(item.categoria||"")}</span>
            <span class="tag"><strong>$</strong> ${escapeHtml(String(item.price||""))} ${escapeHtml(item.currency||"")}</span>
            <span class="tag">üè™ ${escapeHtml(item.bizName||"")}</span>
          </div>
          ${ownerLine}
          <div class="muted" style="margin-bottom:10px">${escapeHtml(item.desc||"")}</div>
          <div class="row" style="gap:10px; margin-bottom:10px;">
            ${item.phone ? `<a class="btn secondary" style="text-decoration:none;text-align:center" href="tel:${encodeURIComponent(item.phone)}">üìû Llamar</a>` : ``}
            ${item.whatsapp ? `<a class="btn secondary" style="text-decoration:none;text-align:center" href="https://wa.me/${encodeURIComponent((item.whatsapp||"").replace(/[^0-9]/g,''))}" target="_blank">üí¨ WhatsApp</a>` : ``}
          </div>

          ${(mode === "mine") ? `
          <div class="actions">
            <button class="btn" data-act="copy">Copiar info</button>
            <button class="btn secondary" data-act="edit">Editar</button>
            <button class="btn danger" data-act="del">Borrar</button>
          </div>` : ``}

          ${(mode === "admin") ? `
          <div class="actions">
            <button class="btn" data-act="copy">Copiar info</button>
            <button class="btn danger" data-act="adel">Borrar (admin)</button>
          </div>` : ``}

        </div>
      `;

      if(mode === "mine"){
        div.querySelector('[data-act="copy"]').addEventListener("click", ()=>{
          const txt = JSON.stringify({id, ...item}, null, 2);
          copyToClipboard(txt, ()=>toast("Copiado ‚úÖ"), ()=>toast("Copia manual abierta."));
        });
        div.querySelector('[data-act="edit"]').addEventListener("click", ()=>{
          loadToForm(item, id);
          showBiz("publish");
        });
        div.querySelector('[data-act="del"]').addEventListener("click", ()=>delOfferMine(id));
      }

      if(mode === "admin"){
        div.querySelector('[data-act="copy"]').addEventListener("click", ()=>{
          const txt = JSON.stringify({id, ...item}, null, 2);
          copyToClipboard(txt, ()=>toast("Copiado ‚úÖ"), ()=>toast("Copia manual abierta."));
        });
        div.querySelector('[data-act="adel"]').addEventListener("click", ()=>delOfferAdmin(id));
      }

      return div;
    }

    function escapeHtml(s){
      return (s||"").replace(/[&<>"']/g, (m)=>({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[m]));
    }

    // ---- Render p√∫blico
    async function renderPublic(){
      const list = $("publicList");
      list.innerHTML = `<div class="muted">Cargando‚Ä¶</div>`;
      try{
        const snap = await get(ref(db,"publicaciones"));
        const obj = snap.val() || {};
        const arr = Object.entries(obj).map(([id,v])=>({id, ...v}));

        const qtxt = ($("searchPublic").value||"").trim().toLowerCase();
        const filtered = qtxt
          ? arr.filter(o =>
              (o.title||"").toLowerCase().includes(qtxt) ||
              (o.desc||"").toLowerCase().includes(qtxt) ||
              (o.bizName||"").toLowerCase().includes(qtxt)
            )
          : arr;

        list.innerHTML = "";
        if(!filtered.length){
          list.innerHTML = `<div class="muted">No hay ofertas todav√≠a.</div>`;
          return;
        }
        filtered
          .sort((a,b)=> (b.createdAt||0)-(a.createdAt||0))
          .forEach(item=>{
            list.appendChild(offerCard(item, item.id, "public"));
          });
      }catch(e){
        console.error(e);
        list.innerHTML = `<div class="muted">Error cargando publicaciones.</div>`;
      }
    }

    $("searchPublic").addEventListener("input", ()=>{
      if(!viewPublic.classList.contains("hide")) renderPublic();
    });

    // ---- Mis ofertas
    $("btnRefreshMine").addEventListener("click", ()=>attachMineListener(true));

    function attachMineListener(forceOnce=false){
      const list = $("mineList");

      if(!currentUser){
        list.innerHTML = `<div class="muted">Inicia sesi√≥n para ver tus ofertas.</div>`;
        return;
      }

      if(mineUnsub && !forceOnce) return;
      if(mineUnsub){ mineUnsub(); mineUnsub = null; }

      list.innerHTML = `<div class="muted">Cargando‚Ä¶</div>`;
      try{
        const q = query(ref(db,"publicaciones"), orderByChild("ownerUid"), equalTo(currentUser.uid));
        mineUnsub = onValue(q, (snap)=>{
          const obj = snap.val() || {};
          const arr = Object.entries(obj).map(([id,v])=>({id, ...v}));
          list.innerHTML = "";
          if(!arr.length){
            list.innerHTML = `<div class="muted">No hay ofertas guardadas.</div>`;
            return;
          }
          arr.sort((a,b)=>(b.createdAt||0)-(a.createdAt||0)).forEach(item=>{
            list.appendChild(offerCard(item, item.id, "mine"));
          });
        });
      }catch(e){
        console.error(e);
        list.innerHTML = `<div class="muted">Error cargando tus ofertas.</div>`;
      }
    }

    function loadToForm(item, id){
      editingId = id;
      $("categoria").value = item.categoria || "Restaurantes";
      $("title").value = item.title || "";
      $("price").value = item.price || "";
      $("currency").value = item.currency || "CUP";
      $("desc").value = item.desc || "";
      toast("Editando: " + (item.title||""));
    }

    async function delOfferMine(id){
      if(!currentUser) return toast("Inicia sesi√≥n.");
      if(!confirm("¬øSeguro que quieres borrar esta oferta?")) return;
      try{
        await remove(ref(db, "publicaciones/" + id));
        toast("Borrada ‚úÖ");
      }catch(e){
        console.error(e);
        toast("Error borrando: " + (e?.message || e));
      }
    }

    async function delOfferAdmin(id){
      if(!currentUser) return toast("Inicia sesi√≥n.");
      if(!isAdmin) return toast("No eres admin.");
      if(!confirm("ADMIN: ¬øborrar esta oferta?")) return;
      try{
        await remove(ref(db, "publicaciones/" + id));
        toast("Borrada (admin) ‚úÖ");
      }catch(e){
        console.error(e);
        toast("Error admin borrando: " + (e?.message || e));
      }
    }

    // ---- Exportar / importar (MIS ofertas)
    function download(filename, text){
      const a = document.createElement("a");
      a.href = URL.createObjectURL(new Blob([text], {type:"application/json"}));
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    $("btnExportFile").addEventListener("click", async ()=>{
      if(!currentUser) return toast("Inicia sesi√≥n.");
      const snap = await get(query(ref(db,"publicaciones"), orderByChild("ownerUid"), equalTo(currentUser.uid)));
      const obj = snap.val() || {};
      const arr = Object.values(obj);
      const json = JSON.stringify(arr, null, 2);
      download("chambasconecta_mis_ofertas.json", json);
      toast("Archivo exportado ‚úÖ");
    });

    $("btnExportCopy").addEventListener("click", async ()=>{
      if(!currentUser) return toast("Inicia sesi√≥n.");
      const snap = await get(query(ref(db,"publicaciones"), orderByChild("ownerUid"), equalTo(currentUser.uid)));
      const obj = snap.val() || {};
      const arr = Object.values(obj);
      const json = JSON.stringify(arr, null, 2);
      copyToClipboard(json, ()=>toast("Copiado ‚úÖ"), ()=>toast("Copia manual abierta."));
    });

    // ---- ADMIN
    $("btnRefreshAdmin").addEventListener("click", ()=>attachAdminListener(true));
    $("searchAdmin").addEventListener("input", ()=>{
      if(!secAdmin.classList.contains("hide")) renderAdminFromCache();
    });

    function attachAdminListener(forceOnce=false){
      const list = $("adminList");

      if(!currentUser){
        list.innerHTML = `<div class="muted">Inicia sesi√≥n.</div>`;
        return;
      }
      if(!isAdmin){
        list.innerHTML = `<div class="muted">No eres admin.</div>`;
        return;
      }

      if(adminUnsub && !forceOnce) return;
      if(adminUnsub){ adminUnsub(); adminUnsub = null; }

      list.innerHTML = `<div class="muted">Cargando todo‚Ä¶</div>`;
      try{
        adminUnsub = onValue(ref(db,"publicaciones"), (snap)=>{
          const obj = snap.val() || {};
          adminCache = Object.entries(obj).map(([id,v])=>({id, ...v}));
          renderAdminFromCache();
        });
      }catch(e){
        console.error(e);
        list.innerHTML = `<div class="muted">Error cargando admin.</div>`;
      }
    }

    function renderAdminFromCache(){
      const list = $("adminList");
      const qtxt = ($("searchAdmin").value||"").trim().toLowerCase();

      let arr = adminCache || [];
      if(qtxt){
        arr = arr.filter(o =>
          (o.title||"").toLowerCase().includes(qtxt) ||
          (o.desc||"").toLowerCase().includes(qtxt) ||
          (o.bizName||"").toLowerCase().includes(qtxt) ||
          (o.ownerUid||"").toLowerCase().includes(qtxt)
        );
      }

      list.innerHTML = "";
      if(!arr.length){
        list.innerHTML = `<div class="muted">No hay publicaciones.</div>`;
        return;
      }

      arr.sort((a,b)=>(b.createdAt||0)-(a.createdAt||0)).forEach(item=>{
        list.appendChild(offerCard(item, item.id, "admin"));
      });
    }

    $("btnAdminDeleteAll").addEventListener("click", async ()=>{
      if(!currentUser) return toast("Inicia sesi√≥n.");
      if(!isAdmin) return toast("No eres admin.");
      const ok = confirm("‚ö†Ô∏è ADMIN: ¬øSeguro que quieres BORRAR TODO 'publicaciones'?");
      if(!ok) return;
      const ok2 = confirm("√öltima confirmaci√≥n: esto no se puede deshacer. ¬øBORRAR TODO?");
      if(!ok2) return;
      try{
        await remove(ref(db, "publicaciones"));
        toast("TODO borrado ‚úÖ");
      }catch(e){
        console.error(e);
        toast("Error borrando todo: " + (e?.message || e));
      }
    });

    $("btnAdminExportFile").addEventListener("click", ()=>{
      if(!currentUser) return toast("Inicia sesi√≥n.");
      if(!isAdmin) return toast("No eres admin.");
      const json = JSON.stringify(adminCache || [], null, 2);
      download("chambasconecta_todas_las_ofertas.json", json);
      toast("Exportado ‚úÖ");
    });

    $("btnAdminExportCopy").addEventListener("click", ()=>{
      if(!currentUser) return toast("Inicia sesi√≥n.");
      if(!isAdmin) return toast("No eres admin.");
      const json = JSON.stringify(adminCache || [], null, 2);
      copyToClipboard(json, ()=>toast("Copiado ‚úÖ"), ()=>toast("Copia manual abierta."));
    });

    // Modal importar
    const importModal = $("importModal");
    $("btnImportOpen").addEventListener("click", ()=>{
      if(!currentUser) return toast("Inicia sesi√≥n.");
      importModal.style.display = "flex";
      $("importText").value = "";
    });
    $("btnImportClose").addEventListener("click", ()=>importModal.style.display="none");
    importModal.addEventListener("click",(e)=>{ if(e.target===importModal) importModal.style.display="none"; });

    $("btnImportDo").addEventListener("click", async ()=>{
      if(!currentUser) return toast("Inicia sesi√≥n.");
      let arr;
      try{
        arr = JSON.parse($("importText").value.trim());
        if(!Array.isArray(arr)) throw new Error("JSON debe ser una lista []");
      }catch(e){
        return toast("JSON inv√°lido: " + (e?.message || e));
      }
      try{
        for(const item of arr){
          const newRef = push(ref(db,"publicaciones"));
          await set(newRef, {
            ownerUid: currentUser.uid,
            bizName: $("bizName").value.trim() || item.bizName || "Negocio",
            categoria: item.categoria || "Otros",
            title: item.title || "",
            price: item.price || "",
            currency: item.currency || "CUP",
            desc: item.desc || "",
            phone: $("bizPhone").value.trim() || item.phone || "",
            whatsapp: $("bizWa").value.trim() || item.whatsapp || "",
            photo: item.photo || "",
            createdAt: Date.now()
          });
        }
        importModal.style.display="none";
        toast("Importado ‚úÖ");
        showBiz("mine");
      }catch(e){
        console.error(e);
        toast("Error importando: " + (e?.message || e));
      }
    });

    // === COPIAR (con plan B manual) ===
    var copyModal = document.getElementById("copyModal");
    var copyText = document.getElementById("copyText");
    var btnSelectAll = document.getElementById("btnSelectAll");
    var btnCopyClose = document.getElementById("btnCopyClose");

    function openCopyModal(text){
      copyText.value = text;
      copyModal.style.display = "flex";
      setTimeout(function(){
        copyText.focus();
        copyText.select();
      }, 50);
    }
    function closeCopyModal(){ copyModal.style.display = "none"; }

    btnCopyClose && btnCopyClose.addEventListener("click", closeCopyModal);
    copyModal && copyModal.addEventListener("click", function(e){
      if(e.target === copyModal) closeCopyModal();
    });
    btnSelectAll && btnSelectAll.addEventListener("click", function(){
      copyText.focus(); copyText.select();
    });

    function copyToClipboard(text, okCb, errCb){
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(function(){
          okCb && okCb();
        }).catch(function(){
          openCopyModal(text);
          errCb && errCb();
        });
        return;
      }
      try{
        var ta = document.createElement("textarea");
        ta.value = text;
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        ta.style.top = "0";
        document.body.appendChild(ta);
        ta.focus();
        ta.select();
        var ok = document.execCommand("copy");
        document.body.removeChild(ta);

        if(ok){
          okCb && okCb();
        }else{
          openCopyModal(text);
          errCb && errCb();
        }
      }catch(e){
        openCopyModal(text);
        errCb && errCb();
      }
    }

    // Default view
    goHome();
  </script>
</body>
</html>
